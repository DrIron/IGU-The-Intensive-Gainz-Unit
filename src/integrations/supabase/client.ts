// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
const SUPABASE_PUBLISHABLE_KEY = import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY;

// Extract project ref from URL for storage key
const PROJECT_REF = SUPABASE_URL?.match(/https:\/\/([^.]+)\./)?.[1] || 'ghotrbotrywonaejlppg';
const STORAGE_KEY = `sb-${PROJECT_REF}-auth-token`;

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
    flowType: 'implicit',
  }
});

/**
 * Session initialization promise.
 * 
 * Waits for the Supabase client to finish its internal initialization
 * (reading from localStorage and optionally refreshing the token).
 * 
 * IMPORTANT: We do NOT call setSession() here. setSession() triggers
 * a network call to /auth/v1/token which puts the client in a "refreshing"
 * state that blocks ALL supabase.from() and supabase.rpc() queries.
 * 
 * Instead, we let the client initialize naturally via getSession(),
 * which reads from localStorage and refreshes only if needed.
 */
let _sessionReadyResolve: () => void;
export const sessionReady: Promise<void> = new Promise((resolve) => {
  _sessionReadyResolve = resolve;
});

// Let the client initialize naturally — getSession reads from localStorage
// and triggers auto-refresh if the token is expired
supabase.auth.getSession().then(({ data, error }) => {
  if (error) {
    console.warn('[Supabase Client] getSession error:', error.message);
  } else if (data.session) {
    console.log('[Supabase Client] Session initialized via getSession');
  } else {
    console.log('[Supabase Client] No session found');
  }
  _sessionReadyResolve();
}).catch(() => {
  _sessionReadyResolve();
});

// Safety timeout — if getSession hangs (known issue), resolve after 5s
setTimeout(() => {
  _sessionReadyResolve();
}, 5000);
